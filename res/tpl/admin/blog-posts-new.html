<link rel="stylesheet" href="{$path}/res/theme/material/base/assets/examples/css/apps/mailbox.css"><style>#actions-buttons button {
  padding: 2px 5px;
  font-size: 11px;
}
#actions-buttons button .icon {
  font-size: 32px;
}
.page-content-table .table>tbody>tr>td, .page-content-table .table>tbody>tr>th, .page-content-table .table>thead>tr>td, .page-content-table .table>thead>tr>th {
  padding-top: 10px;
  padding-bottom: 10px;
}
.site-menubar-fold.page-aside-fixed.page-aside-left .site-footer {
  margin-left: 310px;
}
#person-footer {
  height: 39px;
}
.page {
  height: calc(100% - 44px);
  min-height: calc(100% - 44px);
  overflow: overlay;
}</style><div class="page bg-white"><div class="page-aside"><div class="page-aside-switch"><i class="icon md-chevron-left" aria-hidden="true"></i> <i class="icon md-chevron-right" aria-hidden="true"></i></div><div class="page-aside-inner page-aside-scroll"><div data-role="container"><div data-role="content"><section class="page-aside-section p-t-0"><div class="panel-primary panel-line p-20"><form id="form-post"><input type="hidden" name="idpost"> <input type="hidden" name="idurl"><div class="panel-heading"><h4 class="panel-title">Propriedades da postagem</h4></div><button type="button" class="btn btn-success btn-add-cover">Adicionar capa</button> <input type="hidden" name="idcover"> <img class="image_fade" id="img-cover" src="{$path}/res/img/placeholder.png" style="height:100px; margin-top:10px"> <img src="" alt=""><div class="published panel"><h5>Data de publicação</h5><label for="dtpublished">Escolha uma data</label><input type="date" id="dtpublished" name="dtpublished" class="form-control"></div><div class="tags panel"><div class="panel-heading"><h5 class="panel-title">Tags</h5><div class="panel-actions"><a href="javascript:void(0)" class="btn btn-success btn-pure icon md-plus panel-action"></a> <a href="javascript:void(0)" class="btn btn-pure icon md-refresh panel-action"></a></div></div><div class="panel-body"><ul class="p-10 ul-tags" style="list-style:none"></ul></div></div><div class="categories panel"><div class="panel-heading"><h5 class="panel-title">Categorias</h5><div class="panel-actions"><a href="javascript:void(0)" class="btn btn-success btn-pure icon md-plus panel-action"></a> <a href="javascript:void(0)" class="btn btn-pure icon md-refresh panel-action"></a></div></div><div class="panel-body"><ul class="p-10 ul-categories" style="list-style:none"></ul></div></div></form><button type="submit" class="btn btn-primary btn-block btn-save">Salvar</button> <button type="submit" class="btn btn-primary btn-block btn-publish">Publicar agora</button></div></section></div></div></div></div><div class="page-main p-15"><div class="page-header p-15"><form id="postagem-left"><h1 class="m-0">Nova Postagem</h1><input type="text" name="destitle" class="form-control m-t-10" placeholder="Digite o título"><label for="desurl" class="m-t-10">URL</label><div class="row"><div class="col-sm-4"><span class="form-control-static">/blog/</span></div><div class="col-sm-8"><input type="text" id="desurl" name="desurl" class="form-control"></div></div></form></div><div id="mailContent" class="page-content page-content-table" data-plugin="asSelectable"><h4>Resumo desta postagem</h4><textarea name="descontentshort" id="descontentshort" cols="30" rows="5" class="form-control"></textarea><h3>Escreva a postagem</h3><div id="summernote"></div></div></div></div><div class="modal fade" id="modalTagAdd" tabindex="-1" role="dialog" data-backdrop="false"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title">Adicionar Nova Tag</h4></div><div class="modal-body"><form id="form-tag-add"><div class="form-group form-material" data-plugin="formMaterial"><label for="destag" class="form-control-label">Nome</label><input type="text" name="destag" id="destag" class="form-control"></div></form></div><div class="modal-footer"><button type="button" class="btn btn-default" data-dismiss="modal">Close</button> <button type="button" class="btn btn-primary btn-save-tag">Salvar</button></div></div></div></div><div class="modal fade" id="modalCategoryAdd" tabindex="-1" role="dialog" data-backdrop="false"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title">Adicionar Nova Categoria</h4></div><div class="modal-body"><form id="form-category-add"><div class="form-group form-material" data-plugin="formMaterial"><label for="descategory" class="form-control-label">Nome</label><input type="text" name="descategory" id="descategory" class="form-control"></div></form></div><div class="modal-footer"><button type="button" class="btn btn-default" data-dismiss="modal">Close</button> <button type="button" class="btn btn-primary btn-save-category">Salvar</button></div></div></div></div><script id="tpl-tag" type="text/x-handlebars-template"><li data-idtag="{{idtag}}">
    <span class="checkbox-custom checkbox-primary checkbox-lg">
      <input type="checkbox" class="mailbox-checkbox selectable-item" id="mail_mid_1"
      />
      <label for="mail_mid_1">{{destag}}</label>
    </span>
  </li></script><script id="tpl-category" type="text/x-handlebars-template"><li data-idcategory="{{idcategory}}">
    <span class="checkbox-custom checkbox-primary checkbox-lg">
      <input type="checkbox" class="mailbox-checkbox selectable-item" id="mail_mid_1"
      />
      <label for="mail_mid_1">{{descategory}}</label>
    </span>
  </li></script><script>init.push(function(){

  var post = JSON.parse('{function="json_encode($post)"}');

  console.log(post);

  $("#form-post").formLoad(post);

  $("#postagem-left").formLoad(post);

  $("[name=descontentshort]").val(post.descontentshort);

  $("#summernote").html(post.descontent).summernote({
    height:200
  });

  if(post.despath) $("#img-cover").attr('src', PATH + post.despath);

  var tpl = {
    tag:Handlebars.compile($("#tpl-tag").html()),
    category:Handlebars.compile($("#tpl-category").html())
  };

  var date = new Date();

  var defaultUrl = date.getFullYear()+"-"+date.getMonth()+"-";

  function stringReplace(str){

    str = str.replace(/[áâã]/g,"a");
    str = str.replace(/[óô]/g,"o");
    str = str.replace(/[éê]/g,"e");
    str = str.replace(/[í]/g,"i");
    str = str.replace(/[ç]/g,"c");
    str = str.replace(/[?.]/g,"");

    return str;

  }

  $("[name=destitle]").on("change", function(){

    var destitle = stringReplace($(this).val().replace(/ /g, "-").toLowerCase());

    $("[name=desurl]").val(defaultUrl+destitle);

  });

  $(".btn-add-cover").on("click", function(){

    $.upload({
      url:PATH+"/files",
      multiple:true,
      accept:"*",
      modalInfo:true,
      success:function(r){

        var data = r.data[0];

        $("[name=idcover]").val(data.idfile);
        $("#img-cover").attr('src', PATH + data.desdirectory + data.desfile +"."+ data.desextension);

      }
    });

  });

  function save($btn, inpublished, success = function(){}, failure = function(){}){

    var destitle = $("[name=destitle]").val();

    var data = $("#form-post").formValues();

    if(!destitle){
      data.desurl = defaultUrl+"sem-titulo";
    }else{
      data.desurl = $("[name=desurl]").val();
    }

    data.destitle = destitle;

    var idsTags = [];
    $(".tags [type=checkbox]:checked").each(function(){
      idsTags.push($(this).closest("li").data("idtag"));
    });
    data.idsTags = idsTags.toString();

    var idsCategories = [];
    $(".categories [type=checkbox]:checked").each(function(){
      idsCategories.push($(this).closest("li").data("idcategory"))
    });
    data.idsCategories = idsCategories.toString();

    data.descontent = $('#summernote').next('.note-editor').find('.note-editable').html();
    data.descontentshort = $("[name=descontentshort]").val();

    if(inpublished != undefined) data.dtpublished = date.getFullYear()+"-"+(date.getMonth() + 1)+"-"+date.getDay();

    rest({
      url:PATH+"/blog-posts",
      method:"POST",
      data:data,
      success:function(r){
        $("[name=idpost]").val(r.data.idpost);
        $("[name=idurl]").val(r.data.idurl);
        $btn.btnload("unload");
        System.success();
        if(typeof success == 'function') success();
      },
      failure:function(r){
        $btn.btnload("unload");
        System.showError(r);
        if(typeof failure == 'function') failure();
      }
    });

  }

  $(".btn-save").on("click", function(){

    var $btn = $(this);

    $btn.btnload("load");

    save($btn);

  });

  $(".btn-publish").on("click", function(){

    var $btn = $(this);

    $btn.btnload("unload");

    save($btn, 1);

  });

  $(".tags .md-refresh").on("click", function(){
    loadTags(false);
  });

  $(".tags .md-plus").on("click", function(){

    var $modal = $("#modalTagAdd");

    $modal.modal("show");

    $modal.find(".btn-save-tag").on("click", function(){

      var $btn = $(this);

      $btn.btnload("load");

      rest({
        url:PATH+"/blog-tags",
        method:"POST",
        data:{
          destag:$modal.find("[name=destag]").val()
        },
        success:function(){

          $modal.find(".btn-save-tag").btnload("unload");
          $modal.find("[type=text]").val('');
          $modal.modal("hide");
          loadTags(false);

        },
        failure:function(r){
          $btn.btnload("unload");
          System.showError(r);
        }
      });

    });

  });

  $(".categories .md-refresh").on("click", function(){
    loadCategories(false);
  });

  $(".categories .md-plus").on("click", function(){

    var $modal = $("#modalCategoryAdd");

    $modal.modal("show");

    $modal.find(".btn-save-category").on("click", function(){

      var $btn = $(this);

      $btn.btnload("load");

      rest({
        url:PATH+"/blog-categories",
        method:"POST",
        data:{
          descategory:$modal.find("[name=descategory]").val()
        },
        success:function(){

          $modal.find(".btn-save-category").btnload("unload");
          $modal.find("[type=text]").val('');
          $modal.modal("hide");
          loadCategories(false);

        },
        failure:function(r){
          $btn.btnload("unload");
          System.showError(r);
        }
      });

    });

  });

  function loadTags(cache){

    var $panelTags = System.getPanelApi($(".tags"));

    $panelTags.load();

    var $ul = $(".tags ul");

    $.store({
      url:PATH+"/blog-tags/all",
      cache:cache,
      success:function(data){

        $ul.html('');

        var idsTags = (post.destags != undefined) ? post.destags.split(",") : "";

        $.each(data, function(index, row){

          var $li = $(tpl.tag(row));

          $ul.append($li);

          $.each(idsTags, function(indice, value){

            if(row.idtag == value){
              $li.find("[type=checkbox]").prop("checked", true);
            }

          });

        });

        $panelTags.done();

      },
      failure:function(r){
        $panelTags.done();
        System.showError(r);
      }
    })

  }

  function loadCategories(cache){

    var $panelCategories = System.getPanelApi($(".categories"));

    $panelCategories.load();

    var $ul = $(".categories ul");

    $.store({
      url:PATH+"/blog-categories/all",
      cache:cache,
      success:function(data){

        $ul.html('');

        var idsCategories = (post.descategories != undefined) ? post.descategories.split(",") : "";

        $.each(data, function(index, row){

          var $li = $(tpl.category(row));

          $ul.append($li);

          $.each(idsCategories, function(indice, value){
            if(row.idcategory == value){
              $li.find("[type=checkbox]").prop("checked", true);
            }
          });

        });

        $panelCategories.done();

      },
      failure:function(r){
        $panelCategories.done();
        System.showError(r);
      }
    });

  }

  loadTags(true);
  loadCategories(true);

});</script>